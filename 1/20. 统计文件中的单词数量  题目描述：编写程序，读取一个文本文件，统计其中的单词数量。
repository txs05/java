import java.io.*;
import java.nio.file.*;
import java.util.*;
import java.util.regex.*;

public class WordCount {

    public static void main(String[] args) {
        System.out.println("========== 文本文件单词统计 ==========\n");

        // 测试文件路径
        String filePath = "test.txt";

        // 如果文件不存在，创建示例文件
        createSampleFile(filePath);

        // 方法1: 使用BufferedReader逐行读取
        System.out.println("【方法1: BufferedReader逐行读取】");
        countWordsMethod1(filePath);

        System.out.println("\n-----------------------------------\n");

        // 方法2: 使用Java 8+的Files和Stream API
        System.out.println("【方法2: Files和Stream API】");
        countWordsMethod2(filePath);

        System.out.println("\n-----------------------------------\n");

        // 方法3: 详细统计（包含词频）
        System.out.println("【方法3: 详细统计（包含词频）】");
        detailedWordAnalysis(filePath);
    }

    /**
     * 方法1: 使用BufferedReader逐行读取
     */
    public static void countWordsMethod1(String filePath) {
        int wordCount = 0;
        int lineCount = 0;

        try (BufferedReader reader = new BufferedReader(new FileReader(filePath))) {
            String line;

            while ((line = reader.readLine()) != null) {
                lineCount++;

                // 使用正则表达式分割单词
                // \\s+ 匹配一个或多个空白字符
                String[] words = line.trim().split("\\s+");

                // 跳过空行
                if (line.trim().isEmpty()) {
                    continue;
                }

                wordCount += words.length;

                // 显示每行的单词（调试用）
                // System.out.println("第" + lineCount + "行单词: " + Arrays.toString(words));
            }

            System.out.println("文件: " + filePath);
            System.out.println("总行数: " + lineCount);
            System.out.println("总单词数: " + wordCount);
            System.out.println("平均每行单词数: " +
                    (lineCount > 0 ? String.format("%.2f", (double)wordCount/lineCount) : "0.00"));

        } catch (IOException e) {
            System.err.println("读取文件错误: " + e.getMessage());
        }
    }

    /**
     * 方法2: 使用Java 8+的Files和Stream API
     */
    public static void countWordsMethod2(String filePath) {
        try {
            // 读取所有内容
            String content = Files.readString(Paths.get(filePath));

            // 使用正则表达式匹配单词
            // \b 单词边界, \w+ 一个或多个单词字符
            Pattern pattern = Pattern.compile("\\b\\w+\\b");
            Matcher matcher = pattern.matcher(content);

            long wordCount = matcher.results().count();

            // 统计行数
            long lineCount = content.lines().count();

            // 统计字符数
            long charCount = content.length();

            System.out.println("文件: " + filePath);
            System.out.println("总字符数: " + charCount);
            System.out.println("总行数: " + lineCount);
            System.out.println("总单词数: " + wordCount);

            // 使用另一种方式分割单词
            System.out.println("\n【补充统计】");
            String[] words = content.split("[\\s\\p{Punct}]+"); // 按空白和标点分割
            long filteredCount = Arrays.stream(words)
                    .filter(word -> !word.trim().isEmpty())
                    .count();
            System.out.println("过滤后的单词数: " + filteredCount);

        } catch (IOException e) {
            System.err.println("读取文件错误: " + e.getMessage());
        }
    }

    /**
     * 方法3: 详细统计（包含词频）
     */
    public static void detailedWordAnalysis(String filePath) {
        try {
            String content = Files.readString(Paths.get(filePath));

            // 清理文本：转小写，移除标点
            String cleaned = content.toLowerCase()
                    .replaceAll("[^a-z\\s]", " "); // 只保留字母和空格

            // 分割单词
            String[] words = cleaned.trim().split("\\s+");

            // 使用Map统计词频
            Map<String, Integer> wordFrequency = new HashMap<>();
            List<String> validWords = new ArrayList<>();

            for (String word : words) {
                if (!word.trim().isEmpty() && word.length() > 1) { // 忽略单个字母
                    wordFrequency.put(word, wordFrequency.getOrDefault(word, 0) + 1);
                    validWords.add(word);
                }
            }

            System.out.println("文件: " + filePath);
            System.out.println("有效单词数: " + validWords.size());
            System.out.println("唯一单词数: " + wordFrequency.size());

            // 输出词频最高的5个单词
            System.out.println("\n【词频最高的5个单词】");
            wordFrequency.entrySet().stream()
                    .sorted((a, b) -> b.getValue().compareTo(a.getValue()))
                    .limit(5)
                    .forEach(entry ->
                            System.out.printf("  %-10s : %d次%n", entry.getKey(), entry.getValue()));

            // 输出统计信息
            System.out.println("\n【详细统计】");
            System.out.printf("平均单词长度: %.2f个字母%n",
                    validWords.stream().mapToInt(String::length).average().orElse(0));

            // 找出最长单词
            String longestWord = validWords.stream()
                    .max(Comparator.comparingInt(String::length))
                    .orElse("");
            System.out.println("最长单词: " + longestWord + " (" + longestWord.length() + "个字母)");

        } catch (IOException e) {
            System.err.println("读取文件错误: " + e.getMessage());
        }
    }

    /**
     * 创建示例文件
     */
    private static void createSampleFile(String filePath) {
        try {
            File file = new File(filePath);
            if (!file.exists()) {
                String content = "Java is a high-level programming language.\n" +
                        "It was originally developed by James Gosling at Sun Microsystems.\n" +
                        "Java applications are compiled to bytecode that can run on any Java Virtual Machine.\n" +
                        "The language derives much of its syntax from C and C++.\n" +
                        "Java is one of the most popular programming languages in use, particularly for client-server web applications.\n\n" +
                        "This is a test file for word counting.\n" +
                        "Word word WORD word-count test test testing.";

                Files.writeString(Paths.get(filePath), content);
                System.out.println("已创建示例文件: " + filePath + "\n");
            }
        } catch (IOException e) {
            System.err.println("创建文件失败: " + e.getMessage());
        }
    }
}
